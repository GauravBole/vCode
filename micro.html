<html>

<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
          integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <meta charset="utf-8">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <title>< vCode > lets start code</title>

    <script src="blocly/blockly_compressed.js"></script>
    <script src="sound_blocks.js"></script>

    <script src="blocly/python_compressed.js"></script>

    <script src="blocly/javascript_compressed.js"></script>

    <script src="blocly/blocks_compressed.js"></script>

    <script src="blocly/en.js"></script>

    <script src="blocly/acorn_interpreter.js"></script>

</head>

<body>
<nav class="navbar navbar-expand-lg" style="background-color: #EFEFEF;">
    <a class="navbar-brand" href="#">
        <img src="vcode4.png" width="200" height="80" class="d-inline-block align-top">

    </a>
</nav>
<div class="container" style="padding-top: 60px; text-align: center;">
    <div class="card">
        <div class="card-body">
            <div id="blocklyDiv" style="height: 700px; width: 1060px;"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="id_message" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Message</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="id_message_body">

      </div>
      <div class="modal-footer">

      </div>
    </div>
  </div>
</div>

<xml id="toolbox1" class="container">

    <category name="Controls" colour="#7CCE76" style="background-color: #dd8ab4" style="height: 90px">
        <block type="start"></block>
        <block type="forever"></block>
        <block type="pause">
            <value name="seconds">
                <shadow type="math_number"></shadow>
            </value>
        </block>
        <block type="repeat">
            <value name="val">
                <shadow type="math_number"></shadow>
            </value>
        </block>
        <block type="for">
            <value name="index">
                <shadow type="math_number"></shadow>
            </value>
        </block>
        <block type="while"></block>
        <block type="simpleIf"></block>
        <block type="ifElse"></block>
    </category>

    <category name="Input" colour="#74B6E2" meer-style="input-colour">
        <block type="gesture"></block>
        <block type="readingButtonPressed"></block>
        <block type="acceleration"></block>
        <block type="getReading"></block>
        <block type="soundDetection"></block>
        <block type="rotateBlock"></block>
        <block type="bool"></block>
        <block type="compare">
            <value name="value1">
                <shadow type="math_number"></shadow>
            </value>
            <value name="value2">
                <shadow type="math_number"></shadow>
            </value>
        </block>
        <block type="logic">
            <value name="value1">
                <shadow type="math_number"></shadow>
            </value>
            <value name="value2">
                <shadow type="math_number"></shadow>
            </value>
        </block>
        <block type="not">
            <value name="value3">
                <shadow type="math_number"></shadow>
            </value>
        </block>
        <block type="direction"></block>
        <block type="compassHeading"></block>
        <block type="Temperature"></block>
    </category>



    <category name="Math"  colour="#F2C357" meer-style="math-colour">
        <block type="math_number" colour="#F2C357"></block>
            <block type="arithmetics">
              <value name="input1">
                <shadow type="math_number"> </shadow>
              </value>
              <value name="input2">
                <shadow type="math_number"> </shadow>
              </value>
            </block>
            <block type="minMax">
              <value name="value1">
                <shadow type="math_number"> </shadow>
              </value>
              <value name="value2">
                <shadow type="math_number"> </shadow>
              </value>
            </block>
            <block type="sqrRoot">
              <value name="value1">
                <shadow type="math_number"> </shadow>
              </value>
            </block>
            <block type="round">
              <value name="value1">
                <shadow type="math_number"> </shadow>
              </value>
            </block>
            <block type="absolute">
              <value name="value">
                <shadow type="math_number"> </shadow>
              </value>
            </block>
            <block type="randomNumber">
              <value name="val1">
                <shadow type="math_number"> </shadow>
              </value>
              <value name="val2">
                <shadow type="math_number"> </shadow>
              </value>
            </block>
  </category>


     <category name="Output" colour="#BD94DD" meer-style="output-colour">
            <block type="toneWithBeat" colour="40"></block>
            <block type="tone"></block>
            <block type="playMusic"></block>
            <block type="showNumber">
              <value name="value">
                <shadow type="math_number"> </shadow>
              </value>
            </block>
            <block type="string"></block>
            <block type="icons"></block>
            <block type="clear"></block>
            <block type="showLedNew"></block>
            <block type="plotLed"></block>
            <block type="unplotLed"></block>
  </category>

    <category name="variable" colour="#dd575d">
        <block type="variables_get"></block>
        <block type="variables_set"></block>
        <button text="Create variable" callbackKey="getTargetWorkspace" hidden></button>

    </category>
    <category name="Text" colour="#dd8ab4">
        <block type="print"></block>
        <block type="variables_set"></block>
                <block type="string" colour="#dda73f"></block>

        <button text="Create variable" callbackKey="getTargetWorkspace" hidden></button>
    </category>

</xml>
<br/>
<div style="text-align: center">
    <button type="button" name="stepButton" onclick="runCode()" class="btn btn-secondary">RUN</button>
<!--    <button type="button" name="stepButton" onclick="runCode()" class="btn btn-secondary">Download .hex</button>-->

    <div hidden>
        <textarea type="text" id="code" style="height: 500px ; width: 500px"></textarea>
    </div>
</div>


<script src="blocks/controls.js"></script>
<script src="blocks/inputs.js"></script>
<script src="blocks/maths.js"></script>
<script src="blocks/output.js"></script>
<script src="blocks/texts.js"></script>


<script>

    let workspace = Blockly.inject('blocklyDiv',
        {
            toolbox: document.getElementById('toolbox1'),
            grid:
                {
                    spacing: 20,
                    length: 1,
                    colour: '#aa88ff',
                    snap: false
                },
            zoom:
                {
                    controls: true,
                    wheel: true,
                    startScale: 1.0,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
            trashcan: true
        });

    workspace.registerButtonCallback('getTargetWorkspace', function(button) {
        Blockly.Variables.createVariableButtonHandler(button.getTargetWorkspace(), "", '');
        workspace.refreshToolboxSelection()

   });

</script>

<script type="text/javascript">
    function runCode() {
        var user_code = $('#code').val();
        let import_code = "from microbit import *\n" + "import time \n" + "import math \n" + "import sys \n" + "import machine \n" + "import music \n" + "import random\n";

        var code = import_code + String(user_code);
        let finalCode = "";
         let workspaceCode = "";
    if (code.search('#') !== -1) {
      const wsCodeSplit = code.split('#');
      for (let i = 0; i < wsCodeSplit.length - 1; i++) {
        if (wsCodeSplit[0][0] === 'w') {
          finalCode = workspaceCode + '\n' + wsCodeSplit[1] + wsCodeSplit[0];
        } else {
          finalCode = workspaceCode + '\n' + wsCodeSplit[0] + wsCodeSplit[1];
        }
      }
    }

        $.ajax({
            type: "POST",
            url: '/run_code/',
            data: code,
            cache: false,
            processData: false,
            contentType: false,
            success: function (data) {

                if (data['message'] === "success") {
                    // alert("Your Script Running Check Microbit")
                    $('#id_message_body').html("");
                    $('#id_message_body').append(`<p>Your Script Running please Check Microbit</p>`)
                    $('#id_message').modal('show');
                } else {
                    $('#id_message_body').html("");
                    $('#id_message_body').append(`<p>${data['message']}</p>`)
                    $('#id_message').modal('show');
                    // alert(data['message'])
                }
            }
        })
    }
</script>
<script>
    function myUpdateFunction(event) {

        let code = Blockly.Python.workspaceToCode(workspace);
        document.getElementById('code').value = code;
    }

    workspace.addChangeListener(myUpdateFunction);
</script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script>

</body>
</html>
